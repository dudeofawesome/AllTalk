var PORT = 25585;

// var fs = require('fs');
// var https_options = {
//   key: fs.readFileSync('/Users/DudeOfAwesome/github/AllTalk/server/certificates/key.pem').toString(),
//   cert: fs.readFileSync('/Users/DudeOfAwesome/github/AllTalk/server/certificates/cert.pem').toString()
// };

// var app = require('express')();
// var server = require('https').Server(https_options, app);
// var server = require('http').Server(app);
var server;
var io = require('socket.io');
// var bcrypt = require('bcrypt-nodejs');
var database = require('./database');
// TODO remove this when Chat is no longer required
var headers = require('./headers');

var connectedSockets = [];

module.exports = {
    init: function (httpServer) {
        if (httpServer === undefined) {
            var app = require('express')();
            server = require('http').Server(app);
            io = io(server);
        } else {
            server = httpServer;
            io = io(server);
        }

        io.on('connection', function (socket) {
            // TODO ensure the user is properly authenticated now, so that we don't have to worry about it later
            connectedSockets[socket.id] = true;
            socket.on('get user', function (msg) {
                database.getUserByID(msg._id, function (user) {
                    // TODO check to make sure users are friends before retrieving data
                    io.emit('get user', user);
                });
            });
            socket.on('get chats', function () {
                var chats = {};
                chats[456] = new headers.Chat('Andre Richards', 456, headers.OnlineStatus.ONLINE, headers.ChatStatus.NONE, 'resources/images/profiles/456.jpg', 'now', [{sender: 456, isyou: false,  message: 'Hey man!', time: 1431048720}, {sender: 456, isyou: false,  message: 'How\'s it going?', time: 1431168720}, {sender: 457, isyou: true,  message: 'What\'s up? I\'m feeling pretty pumped to try out All Talk! It seems like it takes all the good parts of the other messaging apps and puts them together into one intuitive place.', time: 1431108720}, {sender: 456, isyou: false,  message: 'IKR! I\'m really liking how it\'s got desktop and mobile clients, with overlay views to boot.', time: 1431128720}, {sender: 457, isyou: true,  message: 'And, add to that the fact that they won\'t ever spy on you, I think this thing could really take off!', time: 1431188720}], [{service: 'google-plus', username: 'j_appleseed@gmail.com', url: 'http://plus.google.com'}, {service: 'twitter', username: '@j_appleseed', url: 'http://twitter.com/j_appleseed'}, {service: 'facebook-box', username: 'johnny.appleseed', url: 'http://facebook.com/johnny.appleseed'}, {service: 'twitch', username: 'j_appleseed', url: 'http://twitch.com'}]);
                chats[450] = new headers.Chat('Trevor Blackwell', 450, headers.OnlineStatus.ONLINE, headers.ChatStatus.NONE, 'resources/images/profiles/450.jpg', 'now', [{sender: 450, isyou: false, message: 'Freemium research & development business-to-consumer traction analytics startup learning curve mass market monetization iPhone. Freemium iteration long tail termsheet creative metrics branding prototype bootstrapping alpha product management technology scrum project series A financing.', time: 1431027660}, {sender: 457, isyou: true,  message: 'User experience business plan sales customer bandwidth ecosystem. Sales mass market ownership growth hacking leverage channels infrastructure equity long tail seed money infographic vesting period responsive web design buzz.', time: 1431030192}, {sender: 450, isyou: false, message: 'Business plan founders graphical user interface disruptive non-disclosure agreement channels market branding ownership freemium user experience.', time: 1431030312}, {sender: 457, isyou: true,  message: 'User experience disruptive branding early adopters non-disclosure agreement buzz entrepreneur incubator.', time: 1431030612}, {sender: 450, isyou: false, message: 'Social proof buzz twitter channels infrastructure advisor sales holy grail business-to-business. Product management social media creative bandwidth twitter business-to-business burn rate monetization gen-z partnership branding.', time: 1431030852}, {sender: 450, isyou: false, message: 'Lean startup startup partnership hypotheses user experience supply chain advisor iteration. Freemium startup paradigm shift network effects conversion iPhone burn rate.', time: 1431031632}, {sender: 457, isyou: true,  message: 'Customer buyer conversion A/B testing monetization accelerator ecosystem paradigm shift analytics equity infrastructure success. Ramen innovator social media. Venture paradigm shift entrepreneur freemium client early adopters analytics non-disclosure agreement release influencer.', time: 1431041412}, {sender: 450, isyou: false, message: 'Partnership gen-z customer founders MVP social proof ramen ownership. Investor virality direct mailing startup market pitch freemium beta ecosystem assets stealth. Crowdsource user experience partnership partner network early adopters business-to-business influencer backing bootstrapping gamification accelerator prototype MVP. Sales virality funding network effects accelerator startup non-disclosure agreement hackathon crowdfunding partnership ownership niche market.', time: 1431055812}, {sender: 457, isyou: true,  message: 'Pitch user experience iPad channels. Monetization virality equity social media deployment technology alpha analytics innovator entrepreneur stock. Traction MVP sales bandwidth early adopters monetization user experience facebook.', time: 1431057672}], [{service: 'google-plus', username: 'a_richards@gmail.com', url: 'http://plus.google.com'}, {service: 'twitter', username: '@a_richards', url: 'http://twitter.com/a_richards'}, {service: 'facebook-box', username: 'andre.richards', url: 'http://facebook.com/andre.richards'}]);
                chats[451] = new headers.Chat('Walter Sobchak', 451, headers.OnlineStatus.ONLINE, headers.ChatStatus.NONE, 'resources/images/profiles/451.jpg', 'now', [{sender: 457, isyou: true,  message: 'Walter, you can\'t do that. These guys\'re like me, they\'re pacifists. Smokey was a conscientious objector. Nihilists! Jesus. Obviously you\'re not a golfer. Yeah man, it really tied the room together. Fine, Dude. As if it\'s impossible to get some nail polish, apply it to someone else\'s toe. Nice marmot. Donny was a good bowler, and a good man. He was… He was one of us. He was a man who loved the outdoors, and bowling, and as a surfer explored the beaches of southern California from Redondo to Calabassos. And he was an avid bowler. And a good friend. He died—he died as so many of his generation, before his time. In your wisdom you took him, Lord. As you took so many bright flowering young men, at Khe San and Lan Doc.', time: 1430613686}, {sender: 451, isyou: false, message: 'I spent most of my time occupying various, um, administration buildings, smoking thai-stick, breaking into the ROTC and bowling. Dude, please!… Is this your homework, Larry? Finishing my coffee. But that is up to little Larry here. Isn\'t it, Larry? I just want to say, sir, that we\'re both enormous—on a personal level. I don\'t see any connection to Vietnam, Walter. Yeah man. Well, you know, the Dude abides.', time: 1430619806}, {sender: 451, isyou: false, message: 'Another Caucasian, Gary. Ever hear of the Seattle Seven? No ma\'am, I didn\'t mean to give the impression that we\'re police exactly. We\'re hoping that it will not be necessary to call the police. I was, uh, one of the authors of the Port Huron Statement —The original Port Huron Statement. Not the compromised second draft. Hello, Pilar? My name is Walter Sobchak, we spoke on the phone, this is my associate Jeffrey Lebowski.', time: 1430619926}, {sender: 457, isyou: true,  message: 'Nice marmot. Yeah man. Well, you know, the Dude abides. We wanted to talk about little Larry. May we come in? I was, uh, one of the authors of the Port Huron Statement —The original Port Huron Statement. Not the compromised second draft. No, look. I do mind. The Dude minds. This will not stand, you know, this aggression will not stand, man. No, the, uh, police chief of Malibu. A real reactionary.', time: 1430620226}, {sender: 451, isyou: false, message: 'And let\'s also not forget—let\'s not forget, Dude—that keeping wildlife, an amphibious rodent, for domestic, you know, within the city —that isn\'t legal either. Walter, this isn\'t a First Amendment thing. All right, Plan B. You might want to watch out the front window there, Larry. You\'re going to enter a world of pain, son. We know that this is your homework. We know you stole a car.', time: 1430622086}], [{service: 'google-plus', username: 'w_sobchak@gmail.com', url: 'http://plus.google.com/w_sobchak'}, {service: 'twitter', username: '@w_sobchak', url: 'http://twitter.com/w_sobchak'}, {service: 'facebook-box', username: 'walter.sobchak', url: 'http://facebook.com/walter.sobchak'}, {service: 'twitch', username: 'w_sobchak', url: 'http://twitch.com/w_sobchak'}]);
                chats[452] = new headers.Chat('Grace Fowler', 452, headers.OnlineStatus.ONLINE, headers.ChatStatus.MUTED, 'resources/images/profiles/452.jpg', 'now', [{sender: 452, isyou: false, message: 'Our ambitions cross-cultural committed fight against oppression reproductive rights sanitation catalyze gender rights lifting people up advancement sustainability microloans positive social change.', time: 1430956223}, {sender: 452, isyou: false, message: 'Assistance public institutions, think tank agency capacity building clean water human rights conflict resolution generosity visionary.', time: 1430956403}, {sender: 457, isyou: true,  message: 'Change lives emergency response, informal economies, governance human experience activism contribution social movement thinkers who make change happen women\'s rights making progress rights-based approach.', time: 1430956463}, {sender: 452, isyou: false, message: 'Hack measures, overcome injustice cross-agency coordination working alongside climate change working families partnership.', time: 1430957663}, {sender: 457, isyou: true,  message: 'Readiness voice catalyst cornerstone honor crowdsourcing catalytic effect criteria. Amplify process humanitarian relief; natural resources combat malaria inclusive capitalism safety economic development, donation Bloomberg replicable indicator benefit combat poverty. Treatment world problem solving innovation; necessities UNICEF globalization.', time: 1430957663}, {sender: 452, isyou: false, message: 'Mobilize; solutions urban collaborative approach growth freedom progressive, UNHCR public service.', time: 1430957720}, {sender: 457, isyou: true,  message: 'Promising development, Jane Jacobs; community health workers volunteer livelihoods resourceful Global South; Kickstarter outcomes life-expectancy transform the world altruism social challenges.', time: 1430957840}, {sender: 457, isyou: true,  message: 'Involvement equality provide women and children philanthropy change, local solutions NGO global citizens enabler best practices community crisis situation.', time: 1430957861}, {sender: 452, isyou: false, message: 'International development results agenda affiliate fellows advocate, Oxfam Cesar Chavez fundraise liberal; development planned giving change-makers. Non-partisan free-speech citizens of change beneficiaries revitalize accelerate progress.', time: 1430957921}, {sender: 457, isyou: true,  message: 'Peaceful courageous technology public sector, Millennium Development Goals interconnectivity, developing sustainable Rosa Parks celebrate nonviolent resistance social impact Arab Spring. Minority insurmountable challenges, environmental economic independence, nonprofit sustainable future relief, social entrepreneurship citizenry legal aid effectiveness. Giving, international, gender immunize civic engagement global Gandhi, sharing economy support socio-economic divide.', time: 1430958281}], [{service: 'google-plus', username: 'j_appleseed@gmail.com', url: 'http://plus.google.com'}, {service: 'twitter', username: '@j_appleseed', url: 'http://twitter.com/j_appleseed'}, {service: 'facebook-box', username: 'johnny.appleseed', url: 'http://facebook.com/johnny.appleseed'}, {service: 'twitch', username: 'j_appleseed', url: 'http://twitch.com/'}]);
                chats[453] = new headers.Chat('The Joker', 453, headers.OnlineStatus.OFFLINE, headers.ChatStatus.NONE, 'resources/images/profiles/453.jpg', 'now', [{sender: 453, isyou: false, message: 'How about a magic trick? I\'m gonna make this pencil disappear. Ta-da!', time: '9:31'}, {sender: 457, isyou: true,  message: 'Bats frighten me. It\'s time my enemies shared my dread.', time: '9:32'}, {sender: 453, isyou: false, message: 'If you\'re good at something, never do it for free.', time: '9:32'}, {sender: 453, isyou: false, message: 'You see, I\'m a guy of simple taste. I enjoy dynamite and gunpowder and gasoline.', time: '9:34'}, {sender: 457, isyou: true,  message: 'I can\'t do that as Bruce Wayne... as a man. I\'m flesh and blood. I can be ignored, destroyed. But as a symbol, I can be incorruptible, I can be everlasting.', time: '9:34'}, {sender: 453, isyou: false, message: 'It was a dog. It was a big dog.', time: '9:36'}, {sender: 457, isyou: true,  message: 'This isn\'t a car.', time: '11:12'}, {sender: 453, isyou: false, message: 'Introduce a little anarchy, upset the established order and everything becomes chaos. I\'m an agent of chaos. Oh, and you know the thing about chaos? It\'s fair.', time: '11:12'}, {sender: 457, isyou: true,  message: 'I seek the means to fight injustice. To turn fear against those who prey on the fearful.', time: '11:13'}, {sender: 453, isyou: false, message: 'And as for the television\'s so-called plan, Batman has no jurisdiction.', time: '11:13'}, {sender: 453, isyou: false, message: 'I just want my phone call.', time: '11:13'}, {sender: 453, isyou: false, message: 'This town deserves a better class of criminal and I\'m gonna give it to them. Tell your men they work for me now. This is my city.', time: 1431048720}], [{service: 'google-plus', username: 'j_appleseed@gmail.com', url: 'http://plus.google.com'}, {service: 'twitter', username: '@j_appleseed', url: 'http://twitter.com/j_appleseed'}, {service: 'facebook-box', username: 'johnny.appleseed', url: 'http://facebook.com/johnny.appleseed'}, {service: 'twitch', username: 'j_appleseed', url: 'http://twitch.com/'}]);
                chats[455] = new headers.Chat('Barack Obama', 455, headers.OnlineStatus.AWAY, headers.ChatStatus.NONE, 'resources/images/profiles/455.jpg', 'now', [{sender: 455, isyou: false, message: 'That they are endowed by their Creator with certain inalienable rights. The hope of a skinny kid with a funny name who believes that America has a place for him, too.', time: '16:41'}, {sender: 457, isyou: true,  message: 'Not once in my conversations with him have I heard him talk about any ethnic group in derogatory terms, or treat whites with whom he interacted with anything but courtesy and respect. Washington\'s been talking about our oil addiction for the last thirty years, and John McCain has been there for twenty-six of them. If your hopes have been dashed again and again, then it\'s best to stop hoping, and settle for what you already know.', time: '17:23'}, {sender: 455, isyou: false, message: 'Born into poverty? Pull yourself up by your own bootstraps - even if you don\'t have boots. For decades, there has been a stalemate: two peoples with legitimate aspirations, each with a painful history that makes compromise elusive. But I do have an unyielding belief that all people yearn for certain things: the ability to speak your mind and have a say in how you are governed; confidence in the rule of law and the equal administration of justice; government that is transparent and doesn\'t steal from the people; the freedom to live as you choose. Fear that because of modernity we will lose of control over our economic choices, our politics, and most importantly our identities - those things we most cherish about our communities, our families, our traditions, and our faith.', time: '17:25'}, {sender: 457, isyou: true,  message: 'And it\'s around this time that some pastors I was working with came up to me and asked if I was a member of a church. That is why we will honor our agreement with Iraq\'s democratically-elected government to remove combat troops from Iraqi cities by July, and to remove all our troops from Iraq by 2012. That is why we are forging service projects in America that bring together Christians, Muslims, and Jews. And while America in the past has focused on oil and gas in this part of the world, we now seek a broader engagement.', time: '17:25'}, {sender: 455, isyou: false, message: 'They know they have to work hard to get ahead - and they want to. Ours is a promise that says government cannot solve all our problems, but what it should do is that which we cannot do for ourselves - protect us from harm and provide every child a decent education; keep our water clean and our toys safe; invest in new schools and new roads and new science and technology. And it is that promise that forty five years ago today, brought Americans from every corner of this land to stand together on a Mall in Washington, before Lincoln\'s Memorial, and hear a young preacher from Georgia speak of his dream. government has gone to court to protect the right of women and girls to wear the hijab, and to punish those who would deny it. Around the world, we can turn dialogue into Interfaith service, so bridges between peoples lead to action - whether it is combating malaria in Africa, or providing relief after a natural disaster. This is important because no development strategy can be based only upon what comes out of the ground, nor can it be sustained while young people are out of work.', time: 1430619806}], [{service: 'google-plus', username: 'j_appleseed@gmail.com', url: 'http://plus.google.com'}, {service: 'twitter', username: '@j_appleseed', url: 'http://twitter.com/j_appleseed'}, {service: 'facebook-box', username: 'johnny.appleseed', url: 'http://facebook.com/johnny.appleseed'}, {service: 'twitch', username: 'j_appleseed', url: 'http://twitch.com'}]);
                io.emit('get chats', chats);
            });
            socket.on('message', function (msg) {
                database.storeMessage(msg);
                // TODO only broadcast to users in the currnent chat
                socket.broadcast.emit('message', msg);
            });
            socket.on('disconnect', function () {
                connectedSockets[socket.id] = undefined;
            });
        });

        this.startServer();
        return this;
    },
    startServer: function () {
        // TODO change modes.TEST to false
        database.init({LOG: false, TEST: true});

        server.listen(PORT, function () {
            console.log('chat server listening on *:' + PORT);
        });
    },
    stopServer: function () {
        server.close();
        return true;
    }
};
